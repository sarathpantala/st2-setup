version: '2.0'

poshmark_devops.report_disk_usage:
  description: Report top 10 disk space usage on host.
  input:
    - host
    - color
  tasks:
    get_disk_usage:
      action: core.remote
      input:
        cmd: "du -hSa /goshposh | sort -hr | head -n 10 | tr '\t' '-' | tr '\n' '  \n\n'"
        hosts: <% $.host %>
      publish:
        files: <% task(get_disk_usage).result.get($.host).stdout %>
      on-success:
        msg_slack

    msg_slack:
      action: chatops.post_message
      input:
        channel: "poshbot_channel"
        message: "Top 10 files taking up space on <% $.host %>\n\n<% $.files %>"
        extra:
          color: <% $.color %>
