version: '2.0'

poshmark_devops.run_scheduled_job:
  description: Restart prod for app and qw to resolve mongodb connection spike.
  input:
    - ds_key
  tasks:
    get_params_for_job:
      action: st2.kv.grep
      input:
        query: "{{ _.ds_key }}"
      on-success:
        - run_jenkins_restart: "{{ _.ds_key == 'schedulerestart' }}"

    run_jenkins_restart:
      action: poshmark_devops.fix_mongo_connection_spike
      input:
        color: 'warning'
        schedule: 'false'
      on-success:
        delete_old_job

    delete_old_job:
      action: st2.kv.delete
      input:
        key: "{{ _.ds_key }}"
