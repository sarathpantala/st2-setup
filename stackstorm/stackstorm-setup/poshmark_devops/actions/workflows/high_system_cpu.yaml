version: '2.0'

poshmark_devops.high_system_cpu:
    description: Log high system cpu usage and take action if alert is not recoverd after 15 mins.
    input:
        - color
        - host
    tasks:
        if_second_alert:
            action: st2.kv.grep
            input:
                query: "{{ _.host }}_high_cpu"
            on-success:
                - log_initial_alert: "{{ not task('if_second_alert').result.result }}"
                - raise_alert: "{{ task('if_second_alert').result.result }}"

        log_initial_alert:
            action: st2.kv.set
            input:
                value: "1"
                key: "{{ _.host }}_high_cpu"
                ttl: 900
            on-success:
                check_prev_alert_count

        check_prev_alert_count:
            action: st2.kv.grep
            input:
                query: "high_cpu_count"
            on-success:
                - log_new_count: "{{ not task('check_prev_alert_count').result.result }}"
                - get_alert_count: "{{ task('check_prev_alert_count').result.result }}"

        get_alert_count:
            action: st2.kv.get
            input:
                key: "high_cpu_count"
            publish:
                old_count: "{{ task('get_alert_count').result.result[0] }}"
            on-success:
                inc_alert_count

        inc_alert_count:
            action: poshmark_devops.increment_high_cpu_count
            input:
                count: "{{ _.old_count }}"
            publish:
                new_count: "{{ task('inc_alert_count').result.result[0] }}"
            on-success:
                - log_new_count: "{{ _.new_count|int < 10 }}"
                - raise_pd_alert: "{{ _.new_count|int >= 10 }}"

        log_new_count:
            action: st2.kv.set
            input:
                value: "{{ _.new_count | default('1') }}"
                key: "high_cpu_count"
                ttl: 90
 
        raise_pd_alert:
            action: pagerduty.launch_incident
            input:
                description: "10 or more high cpu alerts received in the last 60 seconds."
            on-success:
                reset_count

        reset_count:
            action: st2.kv.delete
            input:
                key: 'high_cpu_count'
        
        raise_alert:
            action: pagerduty.launch_incident
            input:
                description: "Received 2 high CPU alerts for {{ _.host }} in last 15 mins"
            on-success:
                ack_alert

        ack_alert:
            action: st2.kv.delete
            input:
                key: "{{ _.host }}_high_cpu"
